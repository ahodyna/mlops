name: ğŸ• Dog Detection CI/CD Pipeline

on:
  push:
    branches: [ master ]
    paths:
      - 'dog-detection-api/**'
      - 'src/train_yolo.py'              
      - 'dog-detection-api/requirements.txt'
      - 'docker-compose.yml'
  workflow_dispatch:
    inputs:
      train_model:
        description: 'ğŸ¯ Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğ¸ Ñ‚Ñ€ĞµĞ½ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ñ–'
        type: boolean
        default: false
      epochs:
        description: 'ğŸ“Š ĞšÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ ĞµĞ¿Ğ¾Ñ…'
        type: string
        default: '5'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/dog-detection-api

jobs:
  # =================== Ğ¢Ğ Ğ•ĞĞ£Ğ’ĞĞĞĞ¯ ===================
  train-model:
    name: ğŸ¯ Train Model
    runs-on: ubuntu-latest
    if: github.event.inputs.train_model == 'true'
    timeout-minutes: 60
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        cache-dependency-path: 'dog-detection-api/requirements.txt'  
        
    - name: ğŸ“¦ Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r dog-detection-api/requirements.txt  
        
    - name: ğŸ—ï¸ Start MLflow
      run: |
        echo "MINIO_ROOT_USER=minioadmin" > .env
        echo "MINIO_ROOT_PASSWORD=minioadmin123" >> .env
        docker-compose up -d minio db mlflow
        sleep 30
        
    - name: ğŸ“Š Create test dataset
      run: |
        mkdir -p dataset_test/images dataset_test/labels
        python -c "
        import cv2, numpy as np
        for i in range(10):
            img = np.random.randint(0, 255, (640, 640, 3), dtype=np.uint8)
            cv2.rectangle(img, (200, 200), (400, 500), (100, 50, 200), -1)
            cv2.imwrite(f'dataset_test/images/dog_{i:03d}.jpg', img)
            with open(f'dataset_test/labels/dog_{i:03d}.txt', 'w') as f:
                f.write('0 0.5 0.4 0.3 0.5\n')
        "
        cat > dataset_test.yaml << EOF
        path: $(pwd)/dataset_test
        train: images
        val: images
        nc: 1
        names: [dog]
        EOF
        
    - name: ğŸ¯ Train model
      run: |
        python src/train_yolo.py \  # â† Ğ’Ğ¸Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ ÑˆĞ»ÑÑ…
          --model yolov8n.pt \
          --epochs ${{ github.event.inputs.epochs || '5' }} \
          --imgsz 416 \
          --batch 2 \
          --name "ci_test_$(date +%Y%m%d_%H%M%S)" \
          --mlflow_uri http://localhost:5001
          
    - name: ğŸ“¤ Upload results
      uses: actions/upload-artifact@v3
      with:
        name: training-results
        path: runs/
        retention-days: 7

  # =================== BUILD & TEST ===================
  build-and-test:
    name: ğŸ³ Build & Test
    runs-on: ubuntu-latest
    needs: [train-model]
    if: always() && (needs.train-model.result == 'success' || needs.train-model.result == 'skipped')
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ³ Setup Docker
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ”‘ Login to Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ·ï¸ Generate tags
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest
          
    - name: ğŸ”¨ Build and push
      uses: docker/build-push-action@v5
      with:
        context: ./dog-detection-api
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ğŸ§ª Test image
      run: |
        # Ğ¢ĞµÑÑ‚ Docker image Ğ· CI environment variables
        docker run -d --name test-api -p 8002:8000 \
          -e CI=true \
          -e GITHUB_ACTIONS=true \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        
        # Ğ§ĞµĞºĞ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾ĞºĞ¸ API Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒÑÑ (ÑˆĞ²Ğ¸Ğ´ÑˆĞµ Ğ·Ğ°Ğ²Ğ´ÑĞºĞ¸ CI Ñ€ĞµĞ¶Ğ¸Ğ¼Ñƒ)
        echo "ğŸ”„ Ğ§ĞµĞºĞ°Ñ”Ğ¼Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞº API..."
        for i in {1..12}; do
          if curl -f http://localhost:8002/health 2>/dev/null; then
            echo "âœ… API Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ğ¹ Ğ¿Ñ–ÑĞ»Ñ $((i*5)) ÑĞµĞºÑƒĞ½Ğ´!"
            break
          fi
          echo "Ğ¡Ğ¿Ñ€Ğ¾Ğ±Ğ° $i/12... ($(($i*5))s)"
          sleep 5
        done
        
        # Ğ¤Ñ–Ğ½Ğ°Ğ»ÑŒĞ½Ğ° Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ°
        if curl -f http://localhost:8002/health; then
          echo "âœ… API Ñ‚ĞµÑÑ‚ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ğ¾!"
        else
          echo "âŒ API Ñ‚ĞµÑÑ‚ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ»ĞµĞ½Ğ¾"
          echo "ğŸ“‹ Ğ›Ğ¾Ğ³Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°:"
          docker logs test-api
          exit 1
        fi
        
        docker stop test-api && docker rm test-api

  # =================== DEPLOY ===================
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: github.ref == 'refs/heads/master' && success()
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸš€ Deploy stack
      run: |
        echo "MINIO_ROOT_USER=minioadmin" > .env
        echo "MINIO_ROOT_PASSWORD=minioadmin123" >> .env
        
        # Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ½Ğ¾Ğ²Ğ¸Ğ¹ Docker image
        export API_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        
        # ĞœĞ¾Ğ´Ğ¸Ñ„Ñ–ĞºÑƒÑ”Ğ¼Ğ¾ docker-compose Ğ´Ğ»Ñ production
        sed "s|build:|image: $API_IMAGE #build:|g" docker-compose.yml > docker-compose.prod.yml
        sed -i "/context:/d; /dockerfile:/d" docker-compose.prod.yml
        
        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ”Ğ¼Ğ¾
        docker-compose -f docker-compose.prod.yml up -d
        sleep 45
        
    - name: ğŸ” Health checks
      run: |
        echo "ğŸ” ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° deployment..."
        
        # API health check
        for i in {1..5}; do
          if curl -f http://localhost:8001/health; then
            echo "âœ… API Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğµ!"
            break
          fi
          echo "Ğ¡Ğ¿Ñ€Ğ¾Ğ±Ğ° $i/5..."
          sleep 10
        done
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ñ–Ğ½ÑˆĞ¸Ñ… ÑĞµÑ€Ğ²Ñ–ÑÑ–Ğ²
        curl -f http://localhost:5001/ && echo "âœ… MLflow Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ğ¹!"
        curl -f http://localhost:3000/ && echo "âœ… Grafana Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ğ¹!"
        
    - name: ğŸ“Š Summary
      run: |
        echo "ğŸ‰ Deployment ÑƒÑĞ¿Ñ–ÑˆĞ½Ğ¸Ğ¹!"
        echo "ğŸ”— API: http://localhost:8001"
        echo "ğŸ“Š MLflow: http://localhost:5001"  
        echo "ğŸ“ˆ Grafana: http://localhost:3000"
        echo "ğŸ·ï¸ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"